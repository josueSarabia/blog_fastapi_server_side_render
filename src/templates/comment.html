<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="{{ url_for('static', path='/css/signup/style.css') }}">
		<link href="{{ url_for('static', path='/css/bootstrap/bootstrap.min.css') }}" rel="stylesheet">
    <title>Document</title>
</head>
<body>
	<div style="height: 100%; display: flex; justify-content: center; align-items: center; padding: 0 !important;" class="main">

		
		<div class="col">
			<button type="button" id="addcommentbutton" class="btn btn-primary"> agregar commentario </button>
			
			<div class="row d-flex justify-content-center">
				<div id="commentsCol" class="col-md-12 col-lg-10 col-xl-8">

				</div>
			</div>

			<div id="commentForm" class="row d-flex justify-content-center d-none">
				<div class="col-md-12 col-lg-10 col-xl-8">
					<div class="card">
						<div class="card-body">
							<div class="d-flex flex-start align-items-center">
								
								<div class="card-footer py-3 border-0" style="background-color: #f8f9fa;width: 100%;">
									<div class="d-flex flex-start w-100">
										<div class="form-outline w-100">
											<textarea class="form-control" id="commentTextArea" rows="4"
												style="background: #fff;" placeholder="Escribe..."></textarea>
										</div>
									</div>
									<div class="float-end mt-2 pt-1">
										<button id="saveCommentButton" type="button" class="btn btn-primary btn-sm">
											<span id="saveloadingbutton" class="" ></span>
											Guardar
										</button>
										<button id="cancelCommentButton" type="button" class="btn btn-outline-primary btn-sm">
											<span id="cancelloadingbutton" class="" ></span>
											Cancelar
										</button>
									</div>
								</div>
	
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

<script>
	var comments_db = []

	function showCommentForm() {
		const commentForm = document.getElementById("commentForm")
		commentForm.classList.remove("d-none")
	}

	function saveComment() {
		const saveloading = document.getElementById("saveloadingbutton")
		saveloading.classList.add("spinner-border")
		saveloading.classList.add("spinner-border-sm")

		const cancelloading = document.getElementById("cancelloadingbutton")
		cancelloading.classList.add("spinner-border")
		cancelloading.classList.add("spinner-border-sm")

		const saveCommentButton = document.getElementById("saveCommentButton");
		const cancelCommentButton = document.getElementById("cancelCommentButton");
		saveCommentButton.setAttribute("disabled", "")
		cancelCommentButton.setAttribute("disabled", "")

		const commentTextArea = document.getElementById("commentTextArea");
		commentTextArea.setAttribute("disabled", "")

		const commentTextAreaValue = commentTextArea.value

		fetch("http://localhost:8000/comments/", {
			method: "post",
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify({
				blog_id: "5ac05386-7b28-416e-a676-cb7742cdcc98",
				content: commentTextAreaValue
			}),
		}).then(async (response) => {
			let comment = await response.json()
			addCommentToList(comment)
			addEventListeners(comment)
			saveloading.classList.remove("spinner-border")
			saveloading.classList.remove("spinner-border-sm")

			cancelloading.classList.remove("spinner-border")
			cancelloading.classList.remove("spinner-border-sm")

			const commentForm = document.getElementById("commentForm")
			commentForm.classList.add("d-none")

			saveCommentButton.removeAttribute("disabled");
			cancelCommentButton.removeAttribute("disabled");
			commentTextArea.removeAttribute("disabled")
			commentTextArea.value = ""
			
		}).catch((error) => {
			saveloading.classList.remove("spinner-border")
			saveloading.classList.remove("spinner-border-sm")

			cancelloading.classList.remove("spinner-border")
			cancelloading.classList.remove("spinner-border-sm")

			saveCommentButton.removeAttribute("disabled");
			cancelCommentButton.removeAttribute("disabled");
		});
		
	}

	function cancelCommentForm() {
		const commentForm = document.getElementById("commentForm")
		commentForm.classList.add("d-none")

		const commentTextArea = document.getElementById("commentTextArea");
		commentTextArea.value = ""
	}

	function loadComments() {
		fetch(`http://localhost:8000/blogs/${'5ac05386-7b28-416e-a676-cb7742cdcc98'}/comments/`, {
			method: "get",
		}).then(async (response) => {
			comments = await response.json()
			const commentsCol = document.getElementById("commentsCol")
			comments.forEach(comment => {
				addCommentToList(comment)
				addEventListeners()
			});
			
		})
	}

	function addCommentToList(comment) {
		comments_db.push(comment)
		let dateComment = new Date(comment.created_at)
		let humanRedableDateComment = dateComment.getDate() +"-"+ (dateComment.getMonth()+1) +"-"+ dateComment.getFullYear()
		let timezoneInHours = dateComment.getTimezoneOffset() / 60
		let humanRedableHoursComment = Math.abs(dateComment.getHours() - timezoneInHours) +":"+( dateComment.getMinutes() < 10 ? "0" : "" ) + dateComment.getMinutes()
		let fullDate = humanRedableDateComment + " " + humanRedableHoursComment

		commentsCol.innerHTML += `
			<div id="${comment.id}" class="card">
				<div class="card-body">

					<div class="d-flex flex-start align-items-center">
						<!-- <img class="rounded-circle shadow-1-strong me-3"
							src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp" alt="avatar" width="60"
							height="60" /> -->
						<div>
							<h6 class="fw-bold text-primary mb-1">${comment.user.name + " " + comment.user.last_name}</h6>
							<p class="text-muted small mb-0">
								${fullDate}
							</p>
						</div>
						<div style="margin-left: 10px;">
							<button type="button" id="editCommentButton${comment.id}" class="btn btn-primary">
								<span id="editloadingbutton${comment.id}" class="" ></span>
								Editar
							</button>
							<button type="button" id="deleteCommentButton${comment.id}" class="btn btn-danger">
								<span id="deleteloadingbutton${comment.id}" class="" ></span>
								Eliminar
							</button>
						</div>
					</div>
					<p id="content${comment.id}" class="mt-3 mb-4 pb-2">
						${comment.content}
					</p>

					<div id="divCommentTextAreaEdit${comment.id}" class="d-flex flex-start w-100 d-none">
						<div class="form-outline w-100">
							<textarea class="form-control" id="commentTextAreaEdit${comment.id}" rows="4"
								style="background: #fff;" placeholder="Escribe..."></textarea>
						</div>
					</div>

					<div id="rowEditFormButtons${comment.id}" class="float-end mt-2 pt-1 d-none">
						<button id="editSaveCommentButton${comment.id}" type="button" class="btn btn-primary btn-sm">
							<span id="editsaveloadingbutton${comment.id}" class="" ></span>
							Guardar
						</button>
						<button id="editCancelCommentButton${comment.id}" type="button" class="btn btn-outline-primary btn-sm">
							<span id="editcancelloadingbutton${comment.id}" class="" ></span>
							Cancelar
						</button>
					</div>
				</div>	
			</div>
		`
	}

	function showEditCommentForm(event) {
		const commentElement = event.target
		const commentId = event.target.id.replace("editCommentButton", "")

		const editCommentButton = document.getElementById("editCommentButton" + commentId);
		const deleteCommentButton = document.getElementById("deleteCommentButton" + commentId);
		editCommentButton.classList.add("d-none")
		deleteCommentButton.classList.add("d-none")

		const content = document.getElementById("content" + commentId);
		content.classList.add("d-none")

		const divCommentTextAreaEdit = document.getElementById("divCommentTextAreaEdit" + commentId);
		divCommentTextAreaEdit.classList.remove("d-none")

		const commentTextAreaEdit = document.getElementById("commentTextAreaEdit" + commentId);
		commentTextAreaEdit.value = content.innerText.trim()

		const rowEditFormButtons = document.getElementById("rowEditFormButtons" + commentId);
		rowEditFormButtons.classList.remove("d-none")
	}

	function saveEditComment(event) {
		const commentElement = event.target
		const commentId = event.target.id.replace("editSaveCommentButton", "")

		const editsaveloadingbutton = document.getElementById("editsaveloadingbutton" + commentId)
		editsaveloadingbutton.classList.add("spinner-border")
		editsaveloadingbutton.classList.add("spinner-border-sm")

		const editcancelloadingbutton = document.getElementById("editcancelloadingbutton" + commentId)
		editcancelloadingbutton.classList.add("spinner-border")
		editcancelloadingbutton.classList.add("spinner-border-sm")

		const editSaveCommentButton = document.getElementById("editSaveCommentButton" + commentId);
		const editCancelCommentButton = document.getElementById("editCancelCommentButton" + commentId);
		editSaveCommentButton.setAttribute("disabled", "")
		editCancelCommentButton.setAttribute("disabled", "")

		const commentTextAreaEdit = document.getElementById("commentTextAreaEdit" + commentId);
		commentTextAreaEdit.setAttribute("disabled", "")

		const commentTextAreaEditValue = commentTextAreaEdit.value

		updatedComment = comments_db.filter(el =>el.id == commentId)[0]
		updatedComment.content = commentTextAreaEditValue


		fetch("http://localhost:8000/comments/", {
			method: "put",
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify({...updatedComment}),
		}).then(async (response) => {
			editsaveloadingbutton.classList.remove("spinner-border")
			editsaveloadingbutton.classList.remove("spinner-border-sm")
			editcancelloadingbutton.classList.remove("spinner-border")
			editcancelloadingbutton.classList.remove("spinner-border-sm")
			editSaveCommentButton.removeAttribute("disabled")
			editCancelCommentButton.removeAttribute("disabled")
			commentTextAreaEdit.removeAttribute("disabled")

			const editCommentButton = document.getElementById("editCommentButton" + commentId);
			const deleteCommentButton = document.getElementById("deleteCommentButton" + commentId);
			editCommentButton.classList.remove("d-none")
			deleteCommentButton.classList.remove("d-none")

			const content = document.getElementById("content" + commentId);
			content.innerText = commentTextAreaEdit.value.trim()
			content.classList.remove("d-none")

			const divCommentTextAreaEdit = document.getElementById("divCommentTextAreaEdit" + commentId);
			divCommentTextAreaEdit.classList.add("d-none")

			const rowEditFormButtons = document.getElementById("rowEditFormButtons" + commentId);
			rowEditFormButtons.classList.add("d-none")

		})
	}

	function cancelEditComment(event) {
		const commentElement = event.target
		const commentId = event.target.id.replace("editCancelCommentButton", "")

		const editCommentButton = document.getElementById("editCommentButton" + commentId);
		const deleteCommentButton = document.getElementById("deleteCommentButton" + commentId);
		editCommentButton.classList.remove("d-none")
		deleteCommentButton.classList.remove("d-none")

		const content = document.getElementById("content" + commentId);
		content.classList.remove("d-none")

		const divCommentTextAreaEdit = document.getElementById("divCommentTextAreaEdit" + commentId);
		divCommentTextAreaEdit.classList.add("d-none")

		const commentTextAreaEdit = document.getElementById("commentTextAreaEdit" + commentId);
		commentTextAreaEdit.value = content.innerText.trim()


		const rowEditFormButtons = document.getElementById("rowEditFormButtons" + commentId);
		rowEditFormButtons.classList.add("d-none")
	}

	function deleteComment(event) {
		const commentElement = event.target
		const commentId = event.target.id.replace("deleteCommentButton", "")

		const editloadingbutton = document.getElementById("editloadingbutton" + commentId)
		editloadingbutton.classList.add("spinner-border")
		editloadingbutton.classList.add("spinner-border-sm")

		const deleteloadingbutton = document.getElementById("deleteloadingbutton" + commentId)
		deleteloadingbutton.classList.add("spinner-border")
		deleteloadingbutton.classList.add("spinner-border-sm")

		const editCommentButton = document.getElementById("editCommentButton" + commentId);
		const deleteCommentButton = document.getElementById("deleteCommentButton" + commentId);
		editCommentButton.setAttribute("disabled", "")
		deleteCommentButton.setAttribute("disabled", "")

		fetch("http://localhost:8000/comments/"+commentId, {
			method: "delete",
		}).then(async (response) => {
			const commentsList = document.getElementById("commentsCol");
			const commentElement = document.getElementById(commentId);
			commentsList.removeChild(commentElement)
		})

	}

	function addEventListeners() {
		comments_db.forEach(el => {
			const editCommentButton = document.getElementById("editCommentButton" + el.id)
			editCommentButton.addEventListener('click', function (event) {
				showEditCommentForm(event)
			}, false)

			const editSaveCommentButton = document.getElementById("editSaveCommentButton" + el.id)
			editSaveCommentButton.addEventListener('click', function (event) {
				saveEditComment(event)
			}, false)

			const editCancelCommentButton = document.getElementById("editCancelCommentButton" + el.id)
			editCancelCommentButton.addEventListener('click', function () {
				cancelEditComment(event)
			}, false)

			const deleteCommentButton = document.getElementById("deleteCommentButton" + el.id)
			deleteCommentButton.addEventListener('click', function () {
				deleteComment(event)
			}, false)
		})
	}

	window.onload = function () {
		const addcommentbutton = document.getElementById("addcommentbutton")
		addcommentbutton.addEventListener('click', function () {
			showCommentForm()
		}, false)

		const saveCommentButton = document.getElementById("saveCommentButton")
		saveCommentButton.addEventListener('click', function () {
			saveComment()
		}, false)

		const cancelCommentButton = document.getElementById("cancelCommentButton")
		cancelCommentButton.addEventListener('click', function () {
			cancelCommentForm()
		}, false)

		loadComments()

	}

</script>

</html>